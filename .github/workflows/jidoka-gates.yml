name: Jidoka Quality Gates
on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  tier1-quick-checks:
    name: "Tier 1: Quick Checks (Sub-Second)"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cargo Check (Safety)
        run: cargo check --all-features

      - name: Clippy (Lints)
        run: cargo clippy --all-features -- -D warnings

      - name: Rustfmt (Formatting)
        run: cargo fmt -- --check

      - name: Unit Tests
        run: cargo test --lib --all-features

  tier2-commit-gates:
    name: "Tier 2: Commit Gates (1-5 Minutes)"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install Tools
        run: |
          cargo install cargo-llvm-cov || true
          cargo install cargo-audit || true
          cargo install cargo-deny || true

      - name: Full Test Suite
        run: cargo test --all-features

      - name: Coverage Check (â‰¥95% target)
        run: |
          cargo llvm-cov --all-features --lcov --output-path lcov.info
          cargo llvm-cov report --summary-only

      - name: Documentation Check
        run: cargo doc --no-deps --all-features --document-private-items

  tier3-security-audit:
    name: "Tier 3: Security Audit"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo Audit (CVE Scan)
        run: |
          cargo install cargo-audit || true
          cargo audit

      - name: Cargo Deny (License + Source)
        run: |
          cargo install cargo-deny || true
          cargo deny check licenses
          cargo deny check sources
          cargo deny check advisories
